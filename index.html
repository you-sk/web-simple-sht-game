<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STELLAR STRIKER (修正版)</title>
    <style>
        /* CSSは変更ありません */
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #111;
            font-family: 'Inter', sans-serif;
            color: white;
            overflow: hidden;
        }
        #game-container {
            position: relative;
            width: 480px;
            height: 720px;
            margin-bottom: 10px;
        }
        canvas {
            background-color: #f0f0f0;
            border: 2px solid #333;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            border-radius: 8px;
            display: block;
        }
        #game-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0,0,0,0.5);
            pointer-events: none;
        }
        #game-overlay.active {
            display: flex;
        }
        #message {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px 40px;
            border-radius: 10px;
            color: white;
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        #action-button {
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #3498db;
            color: white;
            font-weight: bold;
            pointer-events: auto;
        }
        #debug-controls {
            color: #ccc;
        }
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
     <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head><body>
    <div id="game-container">
         <canvas id="gameCanvas"></canvas>
         <div id="game-overlay">
            <div id="message"></div>
            <button id="action-button"></button>
         </div>
    </div>
    <div id="debug-controls">
        <label>
            <input type="checkbox" id="invincible-checkbox">
            無敵モード
        </label>
    </div>

    <script>
        // --- DOM要素の取得 ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameOverlay = document.getElementById('game-overlay');
        const messageEl = document.getElementById('message');
        const actionButton = document.getElementById('action-button');
        const invincibleCheckbox = document.getElementById('invincible-checkbox');
        
        // --- 基本設定 ---
        const canvasWidth = 480;
        const canvasHeight = 720;
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        
        const STAGE_DURATION_SECONDS = 30;
        const FRAMES_PER_SECOND = 60;
        const TOTAL_GAME_FRAMES = STAGE_DURATION_SECONDS * FRAMES_PER_SECOND;
        
        // --- グローバル変数 ---
        // gameStateに 'endscreen' という状態が追加されます（コード内でのみ使用）
        let gameFrame, gameState, score, highScore, currentStage, isInvincible;
        let player, bullets, enemies, enemyBullets, boss, bossBullets, explosions, titleStars;
        let background, stageData, enemyData, tileColors;
        let stageDataIndex, enemyDataIndex;
        let uiActionCooldown = 0;
        let stageStartTimer = 0;

        // --- 入力処理 ---
        const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false, ' ': false, 'Enter': false };
        document.addEventListener('keydown', (e) => { 
            if (e.key in keys) { e.preventDefault(); keys[e.key] = true; }
        });
        document.addEventListener('keyup', (e) => { if (e.key in keys) { e.preventDefault(); keys[e.key] = false; }});
        invincibleCheckbox.addEventListener('change', (e) => { isInvincible = e.target.checked; });

        function handleKeyboardInput() { 
            // 【修正点 1】 gameStateのチェック対象を 'gameover'/'game_clear' から 'endscreen' に変更
            if ((gameState === 'title' || gameState === 'endscreen') && keys['Enter'] && uiActionCooldown <= 0) {
                 actionButton.click();
                 uiActionCooldown = 30;
            }
            if (!player || !player.active || gameState === 'stage_start') return; 

            if (keys.ArrowUp) player.y -= player.speed; 
            if (keys.ArrowDown) player.y += player.speed; 
            if (keys.ArrowLeft) player.x -= player.speed; 
            if (keys.ArrowRight) player.x += player.speed;
            
            player.x = Math.max(player.width/2, Math.min(canvasWidth - player.width/2, player.x));
            player.y = Math.max(player.height/2, Math.min(canvasHeight - player.height/2, player.y));

            if (keys[' '] && player.shotCooldown <= 0) shoot();
        }
        
        function handleGamepadInput() {
            const gamepad = navigator.getGamepads()[0];
            if (!gamepad) return;

            // 【修正点 2】 gameStateのチェック対象を 'gameover'/'game_clear' から 'endscreen' に変更
            if ((gameState === 'title' || gameState === 'endscreen') && uiActionCooldown <= 0) {
                if (gamepad.buttons[0].pressed || gamepad.buttons[9].pressed) {
                    actionButton.click();
                    uiActionCooldown = 30;
                }
            }
            
            if (!player || !player.active || gameState === 'stage_start') return;

            const deadZone = 0.2;
            const leftStickX = gamepad.axes[0];
            const leftStickY = gamepad.axes[1];

            if (Math.abs(leftStickX) > deadZone || gamepad.buttons[14].pressed || gamepad.buttons[15].pressed) {
                player.x += (leftStickX || (gamepad.buttons[15].pressed ? 1 : 0) - (gamepad.buttons[14].pressed ? 1 : 0)) * player.speed;
            }
            if (Math.abs(leftStickY) > deadZone || gamepad.buttons[12].pressed || gamepad.buttons[13].pressed) {
                 player.y += (leftStickY || (gamepad.buttons[13].pressed ? 1 : 0) - (gamepad.buttons[12].pressed ? 1 : 0)) * player.speed;
            }
             player.x = Math.max(player.width/2, Math.min(canvasWidth - player.width/2, player.x));
             player.y = Math.max(player.height/2, Math.min(canvasHeight - player.height/2, player.y));

            if (gamepad.buttons[0].pressed && player.shotCooldown <= 0) shoot();
        }
        
        function shoot() {
             const bulletOffset = player.width / 4;
             bullets.push({ x: player.x - bulletOffset, y: player.y, width: 5, height: 15, color: '#f1c40f' });
             bullets.push({ x: player.x + bulletOffset, y: player.y, width: 5, height: 15, color: '#f1c40f' });
             player.shotCooldown = player.shotInterval; 
        }
        
        // --- 更新処理 (変更なし) ---
        function updateBackground() { /* ここから先のコードは、元のコードと同じです */ }
        function updateEnemies() { /* ... */ }
        function updateBoss() { /* ... */ }
        function updateBullets() { /* ... */ }
        function updateEnemyBullets() { /* ... */ }
        function updateBossBullets() { /* ... */ }
        function updateExplosions() { /* ... */ }
        function updateTitleStars() {
            if(!titleStars) return;
            titleStars.forEach(star => {
                star.y += star.speed;
                if (star.y > canvasHeight) {
                    star.y = 0;
                    star.x = Math.random() * canvasWidth;
                }
            });
        }
        function updateAll() {
             if (player && player.shotCooldown > 0) player.shotCooldown--;
             if (uiActionCooldown > 0) uiActionCooldown--;
             
             if(gameState === 'playing' || gameState === 'boss') {
                updateBackground();
                updateEnemies();
                updateBullets();
                updateEnemyBullets();
                updateBossBullets();
             }
             updateExplosions();
        }

        // --- 描画関連 (変更なし) ---
        function drawPlayer() { /* ... */ }
        function drawBoss() { /* ... */ }
        function drawEnemies() { /* ... */ }
        function drawBullets() { /* ... */ }
        function drawEnemyBullets() { /* ... */ }
        function drawBossBullets() { /* ... */ }
        function drawExplosions() { /* ... */ }
        function drawUI() { /* ... */ }
        function drawBackground() { /* ... */ }
        function drawTitleScreen() {
            ctx.fillStyle = '#000020';
            ctx.fillRect(0,0,canvasWidth, canvasHeight);
            
            ctx.fillStyle = 'white';
            titleStars.forEach(star => {
                ctx.fillRect(star.x, star.y, star.size, star.size);
            });

            gameOverlay.classList.add('active');
        }
        function drawStageStart() {
            drawAllGameElements();
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(0, canvasHeight/2 - 60, canvasWidth, 120);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 72px Inter';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(`STAGE ${currentStage}`, canvasWidth/2, canvasHeight/2);
        }
        function drawAllGameElements() {
            drawBackground();
            drawEnemies();
            drawPlayer();
            drawBullets();
            drawEnemyBullets();
            drawBossBullets();
            drawBoss();
            drawExplosions();
            drawUI();
        }

        // --- 当たり判定 (変更なし) ---
        function isColliding(obj1, obj2, bIsCircle = false) { /* ... */ }
        function checkCollisions() { /* ... */ }
        
        // --- ユーティリティ (変更なし) ---
        function createExplosion(x, y, color, count = 20) { /* ... */ }
        function loadStageData(stage) { /* ... */ }
        
        // --- ゲームフロー & メインループ ---
        function setupTitleScreen() {
            gameState = 'title';
            highScore = parseInt(localStorage.getItem('stellarStrikerHighScore')) || 0;
            messageEl.innerHTML = `STELLAR STRIKER<br><span style='font-size: 20px;'>HI-SCORE: ${highScore}</span><br><span style='font-size: 18px;'>Press Enter or Gamepad Button</span>`;
            actionButton.textContent = "ゲーム開始";
            gameOverlay.classList.add('active');
            
            if(!titleStars) {
                 titleStars = [];
                 for(let i=0; i<100; i++) {
                     titleStars.push({
                         x: Math.random() * canvasWidth,
                         y: Math.random() * canvasHeight,
                         size: Math.random() * 2 + 1,
                         speed: Math.random() * 0.5 + 0.2
                     });
                 }
            }
        }
        // showEndScreenはハイスコア更新ロジックを含むため、変更ありません
        function showEndScreen(message, buttonText) {
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('stellarStrikerHighScore', highScore);
                message += `<br><span style='font-size: 24px;'>HI-SCORE UPDATED!</span>`;
            }
            messageEl.innerHTML = message;
            actionButton.textContent = buttonText;
            gameOverlay.classList.add('active');
        }
        
        function init(stage = 1) {
            currentStage = stage; gameFrame = 0; 
            gameState = 'stage_start';
            stageStartTimer = 120; // 2秒
            
            if (stage === 1) { score = 0; highScore = parseInt(localStorage.getItem('stellarStrikerHighScore')) || 0; }
            loadStageData(currentStage);
            player = { x: canvas.width / 2, y: canvas.height - 80, width: 40, height: 40, speed: 5, color: '#3498db', shotCooldown: 0, shotInterval: 15, active: true };
            bullets = []; enemies = []; enemyBullets = []; bossBullets = []; explosions = [];
            boss = { x: canvas.width / 2, y: -120, width: 180, height: 120, speed: 2, hp: 40 * stage, maxHp: 40 * stage, color: '#c0392b', active: false, vulnerable: false, attackCooldown: 120, attackPattern: 0 };
            background = { speed: 2, elements: [] };
            stageDataIndex = 0; enemyDataIndex = 0;
            gameOverlay.classList.remove('active');
            isInvincible = invincibleCheckbox.checked;
            uiActionCooldown = 30;
        }

        function gameLoop() {
            handleKeyboardInput();
            handleGamepadInput();
            
            switch (gameState) {
                case 'title':
                    updateTitleStars();
                    drawTitleScreen();
                    break;
                case 'stage_start':
                    updateBackground();
                    drawStageStart();
                    stageStartTimer--;
                    if(stageStartTimer <= 0) gameState = 'playing';
                    break;
                case 'playing': 
                case 'boss':
                    updateAll();
                    if (gameState === 'playing') { gameFrame++; if (gameFrame > TOTAL_GAME_FRAMES) { gameState = 'boss'; boss.active = true; }
                    } else if (gameState === 'boss') { updateBoss(); }
                    checkCollisions();
                    drawAllGameElements();
                    break;
                // 【修正点 3】 ゲーム終了後の状態管理を修正
                case 'gameover': 
                case 'game_clear': 
                case 'stage_clear':
                     updateExplosions();
                     drawAllGameElements(); // 最後のフレームを描画
                     if (explosions.length === 0) {
                         if (gameState === 'gameover') { 
                            showEndScreen(`GAME OVER<br><span style='font-size: 24px;'>SCORE: ${score}</span>`, 'タイトルへ戻る');
                            gameState = 'endscreen'; // 新しい状態に移行して、showEndScreenの再実行を防ぐ
                         }
                         else if (gameState === 'game_clear') { 
                            showEndScreen(`GAME CLEAR!<br><span style='font-size: 24px;'>SCORE: ${score}</span>`, 'タイトルへ戻る');
                            gameState = 'endscreen'; // 同様に新しい状態へ移行
                         }
                         else if (gameState === 'stage_clear') { 
                            init(currentStage + 1); 
                         }
                     }
                     break;
                // 【修正点 4】 ユーザーの入力を待つだけの新しい状態を追加
                case 'endscreen':
                    // この状態ではゲームの更新を行わず、入力待ちとする
                    break;
            }
            if(uiActionCooldown > 0) uiActionCooldown--;
            requestAnimationFrame(gameLoop);
        }

        // --- イベントリスナー & 初期化 ---
        actionButton.addEventListener('click', () => {
            // 【修正点 5】 gameStateのチェック対象を 'gameover'/'game_clear' から 'endscreen' に変更
            if (gameState === 'title') { 
                init(1); 
            } 
            else if (gameState === 'endscreen') {
                setupTitleScreen();
            }
        });
        
        // --- データ定義とその他の関数 (変更なしのため、元のコードのままです) ---
        updateBackground=function(){if(gameState==='boss')background.speed=0;else background.speed=2;while(stageDataIndex<stageData.length&&stageData[stageDataIndex].time<=gameFrame){const data=stageData[stageDataIndex];background.elements.push({x:data.x,y:-data.height,width:data.width,height:data.height,color:tileColors[data.type],shape:data.shape||'rect'});stageDataIndex++;}background.elements.forEach(el=>{el.y+=background.speed;});background.elements=background.elements.filter(el=>el.y<canvas.height);};updateEnemies=function(){while(enemyDataIndex<enemyData.length&&enemyData[enemyDataIndex].time<=gameFrame){const data=enemyData[enemyDataIndex];let enemy={x:data.x,y:-30,width:35,height:35,hp:1,type:data.type,shotCooldown:60,vx:data.vx||0,vy:data.vy||2};if(data.type==='chaser')enemy.color='#e67e22';else if(data.type==='shooter')enemy.color='#9b59b6';else enemy.color='#e74c3c';enemies.push(enemy);enemyDataIndex++;}for(let i=enemies.length-1;i>=0;i--){const e=enemies[i];switch(e.type){case'crosser':e.x+=e.vx;e.y+=e.vy;break;case'chaser':const angle=Math.atan2(player.y-e.y,player.x-e.x);e.x+=Math.cos(angle)*e.vy;e.y+=Math.sin(angle)*e.vy;break;case'shooter':e.x+=e.vx;e.y+=e.vy*0.5;if(e.x<e.width/2||e.x>canvas.width-e.width/2)e.vx*=-1;e.shotCooldown--;if(e.shotCooldown<=0){enemyBullets.push({x:e.x,y:e.y,radius:5,speed:4,color:'#f39c12'});e.shotCooldown=90;}break;}if(e.y>canvas.height+e.height||e.x<-e.width||e.x>canvas.width+e.width){enemies.splice(i,1);}}};updateBoss=function(){if(boss.active&&!boss.vulnerable){if(boss.y<120){boss.y+=boss.speed;}else{boss.vulnerable=true;}return;}if(boss.active&&boss.vulnerable){boss.attackCooldown--;if(boss.attackCooldown<=0){switch(currentStage){case 1:for(let i=0;i<5;i++){const angle=(i-2)*0.3+Math.PI/2;bossBullets.push({x:boss.x,y:boss.y,radius:6,color:'#ff7979',vx:Math.cos(angle)*4,vy:Math.sin(angle)*4});}boss.attackCooldown=100;break;case 2:if(boss.attackPattern%2===0){for(let i=0;i<7;i++){const angle=(i-3)*0.25+Math.PI/2;bossBullets.push({x:boss.x,y:boss.y,radius:6,color:'#ff7979',vx:Math.cos(angle)*4.5,vy:Math.sin(angle)*4.5});}}else{const angle=Math.atan2(player.y-boss.y,player.x-boss.x);bossBullets.push({x:boss.x,y:boss.y,radius:8,color:'#ffbe76',vx:Math.cos(angle)*5,vy:Math.sin(angle)*5});}boss.attackPattern++;boss.attackCooldown=80;break;case 3:if(boss.attackPattern%2===0){for(let i=0;i<9;i++){const angle=(i-4)*0.2+Math.PI/2;bossBullets.push({x:boss.x,y:boss.y,radius:7,color:'#ff7979',vx:Math.cos(angle)*5,vy:Math.sin(angle)*5});}}else{const baseAngle=Math.atan2(player.y-boss.y,player.x-boss.x);for(let i=-1;i<=1;i++){const angle=baseAngle+i*0.2;bossBullets.push({x:boss.x,y:boss.y,radius:8,color:'#ffbe76',vx:Math.cos(angle)*5.5,vy:Math.sin(angle)*5.5});}}boss.attackPattern++;boss.attackCooldown=60;break;}}}};updateBullets=function(){for(let i=bullets.length-1;i>=0;i--){const b=bullets[i];b.y-=10;if(b.y<-b.height)bullets.splice(i,1);}};updateEnemyBullets=function(){for(let i=enemyBullets.length-1;i>=0;i--){const b=enemyBullets[i];b.y+=b.speed;if(b.y>canvas.height)enemyBullets.splice(i,1);}};updateBossBullets=function(){for(let i=bossBullets.length-1;i>=0;i--){const b=bossBullets[i];b.x+=b.vx;b.y+=b.vy;if(b.y>canvas.height||b.x<0||b.x>canvas.width)bossBullets.splice(i,1);}};updateExplosions=function(){for(let i=explosions.length-1;i>=0;i--){const p=explosions[i];p.x+=p.vx;p.y+=p.vy;p.life--;if(p.life<=0){explosions.splice(i,1);}}};drawPlayer=function(){if(!player||!player.active)return;ctx.fillStyle=player.color;ctx.beginPath();ctx.moveTo(player.x,player.y-player.height/2);ctx.lineTo(player.x-player.width/3,player.y+player.height/2);ctx.lineTo(player.x+player.width/3,player.y+player.height/2);ctx.closePath();ctx.fill();ctx.fillStyle='#5dade2';ctx.beginPath();ctx.moveTo(player.x-player.width/3,player.y+player.height/3);ctx.lineTo(player.x-player.width/2,player.y+player.height/2);ctx.lineTo(player.x+player.width/2,player.y+player.height/2);ctx.lineTo(player.x+player.width/3,player.y+player.height/3);ctx.closePath();ctx.fill();};drawBoss=function(){if(boss&&boss.active){ctx.fillStyle=boss.color;ctx.fillRect(boss.x-boss.width/2,boss.y-boss.height/2,boss.width,boss.height);ctx.fillStyle='#e74c3c';ctx.fillRect(boss.x-30,boss.y-30,60,60);ctx.fillStyle='#7f8c8d';ctx.fillRect(boss.x-boss.width/2-20,boss.y-20,20,40);ctx.fillRect(boss.x+boss.width/2,boss.y-20,20,40);if(boss.vulnerable){const hpBarWidth=canvasWidth*0.8;const hpPercentage=boss.hp/boss.maxHp;ctx.fillStyle='#555';ctx.fillRect(canvasWidth/2-hpBarWidth/2,10,hpBarWidth,15);ctx.fillStyle='#e74c3c';ctx.fillRect(canvasWidth/2-hpBarWidth/2,10,hpBarWidth*hpPercentage,15);}}};drawEnemies=function(){if(!enemies)return;enemies.forEach(e=>{ctx.fillStyle=e.color;ctx.beginPath();const w2=e.width/2;const h2=e.height/2;switch(e.type){case'crosser':ctx.moveTo(e.x+w2,e.y);ctx.lineTo(e.x-w2,e.y-h2);ctx.lineTo(e.x-w2,e.y+h2);break;case'chaser':ctx.moveTo(e.x,e.y-h2);ctx.lineTo(e.x+w2,e.y);ctx.lineTo(e.x,e.y+h2);ctx.lineTo(e.x-w2,e.y);break;case'shooter':ctx.moveTo(e.x-w2,e.y+h2);ctx.lineTo(e.x+w2,e.y+h2);ctx.lineTo(e.x+w2*0.7,e.y-h2);ctx.lineTo(e.x-w2*0.7,e.y-h2);break;}ctx.closePath();ctx.fill();});};drawBullets=function(){if(!bullets)return;bullets.forEach(b=>{ctx.fillStyle=b.color;ctx.fillRect(b.x-b.width/2,b.y,b.width,b.height);});};drawEnemyBullets=function(){if(!enemyBullets)return;enemyBullets.forEach(b=>{ctx.fillStyle=b.color;ctx.beginPath();ctx.arc(b.x,b.y,b.radius,0,Math.PI*2);ctx.fill();});};drawBossBullets=function(){if(!bossBullets)return;bossBullets.forEach(b=>{ctx.fillStyle=b.color;ctx.beginPath();ctx.arc(b.x,b.y,b.radius,0,Math.PI*2);ctx.fill();});};drawExplosions=function(){if(!explosions)return;explosions.forEach((p)=>{ctx.globalAlpha=p.life/p.maxLife;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,p.radius,0,Math.PI*2);ctx.fill();});ctx.globalAlpha=1.0;};drawUI=function(){if(typeof score==='undefined')return;ctx.fillStyle='white';ctx.font='20px Inter';ctx.textAlign='left';ctx.textBaseline='top';ctx.fillText(`SCORE: ${score}`,10,10);ctx.fillText(`STAGE: ${currentStage}`,10,35);ctx.textAlign='right';ctx.fillText(`HI-SCORE: ${highScore}`,canvasWidth-10,10);};drawBackground=function(){if(!tileColors)return;ctx.fillStyle=tileColors.base;ctx.fillRect(0,0,canvas.width,canvas.height);if(background&&background.elements)background.elements.forEach(el=>{ctx.fillStyle=el.color;if(el.shape==='pyramid'){ctx.beginPath();ctx.moveTo(el.x,el.y-el.height/2);ctx.lineTo(el.x-el.width/2,el.y+el.height/2);ctx.lineTo(el.x+el.width/2,el.y+el.height/2);ctx.closePath();ctx.fill();}else if(el.shape==='star'){ctx.beginPath();ctx.arc(el.x,el.y,el.width,0,Math.PI*2);ctx.fill();}else{ctx.fillRect(el.x,el.y,el.width,el.height);}});ctx.fillStyle='rgba(0, 0, 0, 0.2)';ctx.fillRect(0,0,canvas.width,canvas.height);};isColliding=function(obj1,obj2,bIsCircle=false){let x1=obj1.x-obj1.width/2,y1=obj1.y-obj1.height/2;if(bIsCircle){x1=obj1.x-obj1.radius;y1=obj1.y-obj1.radius;obj1.width=obj1.height=obj1.radius*2;}const x2=obj2.x-obj2.width/2,y2=obj2.y-obj2.height/2;return x1<x2+obj2.width&&x1+obj1.width>x2&&y1<y2+obj2.height&&y1+obj1.height>y2;};checkCollisions=function(){for(let i=bullets.length-1;i>=0;i--){if(!bullets[i])continue;for(let j=enemies.length-1;j>=0;j--){if(isColliding(bullets[i],enemies[j])){createExplosion(enemies[j].x,enemies[j].y,enemies[j].color);enemies.splice(j,1);bullets.splice(i,1);score+=100;break;}}}if(boss.active){for(let i=bullets.length-1;i>=0;i--){if(!bullets[i])continue;if(isColliding(bullets[i],boss)){if(boss.vulnerable){createExplosion(bullets[i].x,bullets[i].y,'#ffffff',5);boss.hp--;score+=500;if(boss.hp<=0){createExplosion(boss.x,boss.y,boss.color,100);boss.active=false;score+=10000*currentStage;if(currentStage<3){gameState='stage_clear';}else{gameState='game_clear';}}}else{createExplosion(bullets[i].x,bullets[i].y,'#95a5a6',4);}bullets.splice(i,1);break;}}}if(isInvincible)return;for(let i=enemies.length-1;i>=0;i--){if(isColliding(enemies[i],player)){createExplosion(player.x,player.y,player.color,50);player.active=false;gameState='gameover';return;}}for(let i=enemyBullets.length-1;i>=0;i--){if(isColliding(enemyBullets[i],player,true)){createExplosion(player.x,player.y,player.color,50);player.active=false;gameState='gameover';return;}}for(let i=bossBullets.length-1;i>=0;i--){if(isColliding(bossBullets[i],player,true)){createExplosion(player.x,player.y,player.color,50);player.active=false;gameState='gameover';return;}}};createExplosion=function(x,y,color,count=20){for(let i=0;i<count;i++){const angle=Math.random()*Math.PI*2;const speed=Math.random()*5+1;explosions.push({x:x,y:y,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,radius:Math.random()*3+1,color:color,life:30,maxLife:30});}};loadStageData=function(stage){stageData=allStageData[stage-1];enemyData=allEnemyData[stage-1];tileColors=allTileColors[stage-1];};const allTileColors=[{base:'#6ab04c',forest:'#3d5c3a',river:'#4FC3F7',mountain:'#795548',road:'#BDBDBD'},{base:'#f0e68c',pyramid:'#d2b48c',oasis:'#20b2aa',rock:'#a0522d'},{base:'#000020',star:'#ffffff',nebula:'#483d8b',planet:'#4682b4'}];const allStageData=[[{time:60,x:50,width:100,height:100,type:'forest'},{time:120,x:300,width:120,height:80,type:'forest'},{time:240,x:100,width:80,height:150,type:'forest'},{time:300,x:200,width:80,height:200,type:'road'},{time:360,x:200,width:80,height:200,type:'road'},{time:420,x:200,width:80,height:200,type:'road'},{time:480,x:200,width:80,height:200,type:'road'},{time:540,x:200,width:80,height:200,type:'road'},{time:600,x:0,width:canvasWidth,height:80,type:'river'},{time:630,x:0,width:canvasWidth,height:80,type:'river'},{time:660,x:0,width:canvasWidth,height:80,type:'river'},{time:690,x:0,width:canvasWidth,height:80,type:'river'},{time:900,x:30,width:150,height:120,type:'mountain'},{time:980,x:250,width:200,height:180,type:'mountain'},{time:1200,x:10,width:100,height:100,type:'forest'},{time:1300,x:40,width:180,height:150,type:'mountain'},{time:1450,x:350,width:100,height:100,type:'forest'},{time:1500,x:0,width:150,height:150,type:'forest'},{time:1550,x:330,width:150,height:150,type:'forest'},{time:1650,x:100,width:280,height:80,type:'road'},{time:1750,x:180,width:120,height:120,type:'mountain'}],[{time:60,x:100,width:120,height:100,type:'pyramid',shape:'pyramid'},{time:150,x:300,width:80,height:80,type:'rock'},{time:300,x:50,width:200,height:60,type:'oasis'},{time:400,x:350,width:100,height:100,type:'pyramid',shape:'pyramid'},{time:500,x:150,width:60,height:60,type:'rock'},{time:700,x:250,width:150,height:120,type:'pyramid',shape:'pyramid'},{time:800,x:80,width:40,height:40,type:'rock'},{time:900,x:380,width:50,height:50,type:'rock'},{time:1000,x:200,width:120,height:80,type:'oasis'},{time:1200,x:50,width:100,height:80,type:'pyramid',shape:'pyramid'},{time:1300,x:400,width:60,height:100,type:'rock'},{time:1500,x:150,width:180,height:150,type:'pyramid',shape:'pyramid'}],[{time:10,x:10,width:2,height:2,type:'star',shape:'star'},{time:20,x:400,width:1,height:1,type:'star',shape:'star'},{time:30,x:200,width:3,height:3,type:'star',shape:'star'},{time:100,x:0,width:150,height:400,type:'nebula'},{time:150,x:100,width:3,height:3,type:'star',shape:'star'},{time:160,x:300,width:1,height:1,type:'star',shape:'star'},{time:400,x:300,width:120,height:120,type:'planet'},{time:450,x:450,width:2,height:2,type:'star',shape:'star'},{time:800,x:240,width:300,height:200,type:'nebula'},{time:900,x:50,width:80,height:80,type:'planet'},{time:1000,x:20,width:1,height:1,type:'star',shape:'star'},{time:1500,x:400,width:150,height:150,type:'planet'}]];const allEnemyData=[[{time:120,x:80,type:'crosser',vx:2,vy:2},{time:150,x:canvasWidth-80,type:'crosser',vx:-2,vy:2},{time:200,x:canvasWidth/2,type:'chaser'},{time:250,x:100,type:'chaser'},{time:250,x:canvasWidth-100,type:'chaser'},{time:350,x:canvasWidth/2,type:'shooter',vx:2,vy:1},{time:400,x:40,type:'crosser',vx:3,vy:3},{time:400,x:canvasWidth-40,type:'crosser',vx:-3,vy:3},{time:450,x:canvasWidth/2,type:'chaser'},{time:500,x:120,type:'chaser'},{time:500,x:canvasWidth-120,type:'chaser'},{time:550,x:60,type:'crosser',vx:2,vy:2},{time:550,x:canvasWidth-60,type:'crosser',vx:-2,vy:2},{time:600,x:100,type:'shooter',vx:2,vy:1},{time:650,x:canvasWidth-100,type:'shooter',vx:-2,vy:1},{time:700,x:canvasWidth/2,type:'chaser'},{time:720,x:canvasWidth/2-40,type:'chaser'},{time:720,x:canvasWidth/2+40,type:'chaser'},{time:740,x:canvasWidth/2-80,type:'chaser'},{time:740,x:canvasWidth/2+80,type:'chaser'},{time:800,x:20,type:'crosser',vx:4,vy:2},{time:810,x:20,type:'crosser',vx:4,vy:2},{time:820,x:20,type: 'crosser',vx:4,vy:2},{time:830,x:20,type:'crosser',vx:4,vy:2},{time:900,x:canvasWidth-20,type:'crosser',vx:-4,vy:2},{time:910,x:canvasWidth-20,type:'crosser',vx:-4,vy:2},{time:920,x:canvasWidth-20,type:'crosser',vx:-4,vy:2},{time:930,x:canvasWidth-20,type:'crosser',vx:-4,vy:2},{time:1000,x:100,type:'shooter',vx:0,vy:2},{time:1000,x:canvasWidth/2,type:'shooter',vx:0,vy:2},{time:1000,x:canvasWidth-100,type:'shooter',vx:0,vy:2},{time:1150,x:100,type:'chaser'},{time:1150,x:canvasWidth-100,type:'chaser'},{time:1200,x:canvasWidth/2,type:'chaser'},{time:1250,x:40,type:'crosser',vx:2,vy:3},{time:1250,x:canvasWidth-40,type:'crosser',vx:-2,vy:3},{time:1300,x:100,type:'shooter',vx:3,vy:1},{time:1300,x:canvasWidth-100,type:'shooter',vx:-3,vy:1},{time:1350,x:150,type:'chaser'},{time:1350,x:canvasWidth-150,type:'chaser'},{time:1400,x:canvasWidth/2,type:'shooter',vx:2,vy:1},{time:1450,x:canvasWidth/2,type:'chaser'}],[{time:100,x:50,type:'chaser',vy:2.5},{time:100,x:canvasWidth-50,type:'chaser',vy:2.5},{time:180,x:100,type:'shooter',vx:3,vy:1.5},{time:250,x:canvasWidth/2,type:'chaser',vy:3},{time:300,x:20,type:'crosser',vx:4,vy:3},{time:300,x:canvasWidth-20,type:'crosser',vx:-4,vy:3},{time:400,x:100,type:'shooter',vx:-3,vy:1},{time:400,x:canvasWidth-100,type:'shooter',vx:3,vy:1},{time:500,x:canvasWidth/2-100,type:'chaser',vy:2.5},{time:500,x:canvasWidth/2+100,type:'chaser',vy:2.5},{time:600,x:40,type:'crosser',vx:5,vy:2},{time:620,x:40,type:'crosser',vx:5,vy:2},{time:640,x:40,type:'crosser',vx:5,vy:2},{time:700,x:canvasWidth/2,type:'shooter',vx:0,vy:2},{time:750,x:canvasWidth/2-150,type:'chaser',vy:3},{time:750,x:canvasWidth/2+150,type:'chaser',vy:3},{time:850,x:canvasWidth-40,type:'crosser',vx:-5,vy:2},{time:870,x:canvasWidth-40,type:'crosser',vx:-5,vy:2},{time:890,x:canvasWidth-40,type:'crosser',vx:-5,vy:2},{time:1000,x:100,type:'shooter',vx:2,vy:2},{time:1000,x:canvasWidth-100,type:'shooter',vx:-2,vy:2},{time:1100,x:canvasWidth/2,type:'chaser',vy:3.5},{time:1150,x:canvasWidth/2,type:'chaser',vy:3.5},{time:1200,x:40,type:'crosser',vx:4,vy:4},{time:1200,x:canvasWidth-40,type:'crosser',vx:-4,vy:4},{time:1300,x:canvasWidth/2-100,type:'shooter',vx:4,vy:1},{time:1300,x:canvasWidth/2+100,type:'shooter',vx:-4,vy:1},{time:1400,x:100,type:'chaser',vy:3},{time:1400,x:canvasWidth-100,type:'chaser',vy:3}],[{time:80,x:canvasWidth/2,type:'chaser',vy:3.5},{time:150,x:60,type:'shooter',vx:3,vy:2},{time:150,x:canvasWidth-60,type:'shooter',vx:-3,vy:2},{time:250,x:30,type:'crosser',vx:5,vy:3},{time:270,x:30,type:'crosser',vx:5,vy:3},{time:350,x:canvasWidth-30,type:'crosser',vx:-5,vy:3},{time:370,x:canvasWidth-30,type:'crosser',vx:-5,vy:3},{time:450,x:100,type:'chaser',vy:3},{time:450,x:canvasWidth-100,type:'chaser',vy:3},{time:480,x:canvasWidth/2,type:'chaser',vy:4},{time:550,x:100,type:'shooter',vx:-2,vy:2},{time:550,x:canvasWidth-100,type:'shooter',vx:2,vy:2},{time:650,x:canvasWidth/2-150,type:'chaser',vy:3.5},{time:650,x:canvasWidth/2,type:'chaser',vy:3.5},{time:650,x:canvasWidth/2+150,type:'chaser',vy:3.5},{time:750,x:50,type:'shooter',vx:4,vy:1},{time:750,x:canvasWidth-50,type:'shooter',vx:-4,vy:1},{time:850,x:20,type:'crosser',vx:6,vy:2},{time:860,x:20,type:'crosser',vx:6,vy:2},{time:870,x:20,type:'crosser',vx:6,vy:2},{time:880,x:20,type:'crosser',vx:6,vy:2},{time:950,x:canvasWidth-20,type:'crosser',vx:-6,vy:2},{time:960,x:canvasWidth-20,type:'crosser',vx:-6,vy:2},{time:970,x:canvasWidth-20,type:'crosser',vx:-6,vy:2},{time:980,x:canvasWidth-20,type:'crosser',vx:-6,vy:2},{time:1100,x:canvasWidth/2-100,type:'shooter',vx:0,vy:3},{time:1100,x:canvasWidth/2+100,type:'shooter',vx:0,vy:3},{time:1200,x:canvasWidth/2,type:'chaser',vy:4.5},{time:1250,x:100,type:'chaser',vy:4},{time:1250,x:canvasWidth-100,type:'chaser',vy:4},{time:1350,x:canvasWidth/2,type:'shooter',vx:5,vy:2},{time:1380,x:canvasWidth/2,type:'shooter',vx:-5,vy:2}]];

        // --- 初期化してタイトル表示 ---
        setupTitleScreen();
        gameLoop();
    </script>
</body>
</html>
